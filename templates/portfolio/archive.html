{% extends 'base.html' %}

{% block title %}Archive | SC GARDEN{% endblock %}

{% block content %}
<section class="max-w-6xl mx-auto px-6 py-16">
    <h1 class="text-3xl font-light mb-4">Archive</h1>
    <p class="text-sm text-gray-500 mb-8">전체 기록을 최신순으로 정리했습니다.</p>

    <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
        <div class="text-xs text-gray-500">
            {% if uploaded_count %}
                이번 업로드에서 {{ uploaded_count }}장이 저장되었습니다.
            {% else %}
                사진을 업로드하고 5열 그리드로 확인하세요.
            {% endif %}
        </div>
        <button id="upload-toggle" type="button" class="px-4 py-2 border border-gray-900 text-xs uppercase tracking-widest">사진 업로드</button>
    </div>

    <form id="upload-form" method="post" enctype="multipart/form-data" class="hidden border border-dashed border-gray-300 p-6 mb-10">
        {% csrf_token %}
        <input id="file-input" type="file" name="images" multiple accept="image/*" class="hidden" />
        <div id="dropzone" class="flex flex-col items-center justify-center gap-2 bg-gray-50 py-10 text-sm text-gray-500">
            <div id="dropzone-empty" class="flex flex-col items-center gap-2">
                <span>사진을 드래그 앤 드롭 하세요.</span>
                <span class="text-xs">한번에 최대 50장까지 업로드 가능합니다.</span>
            </div>
            <div id="preview-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 w-full"></div>
        </div>
        <div class="flex flex-wrap items-center gap-3 mt-4">
            <button type="submit" class="px-4 py-2 bg-gray-900 text-white text-xs uppercase tracking-widest">업로드 시작</button>
            <span id="file-count" class="text-xs text-gray-500">선택된 파일 없음</span>
        </div>
        {% if upload_error %}
            <div class="text-xs text-red-500 mt-3">{{ upload_error }}</div>
        {% endif %}
    </form>

    <div class="flex flex-wrap gap-2 mb-10">
        <a href="{% url 'portfolio:archive' %}" class="px-3 py-1 text-xs border rounded-full {% if not active_tag %}bg-gray-900 text-white border-gray-900{% else %}border-gray-200 text-gray-600{% endif %}">전체</a>
        {% for tag in tags %}
            <a href="{% url 'portfolio:archive' %}?tag={{ tag.slug }}" class="px-3 py-1 text-xs border rounded-full {% if active_tag == tag.slug %}bg-gray-900 text-white border-gray-900{% else %}border-gray-200 text-gray-600{% endif %}">{{ tag.name }}</a>
        {% endfor %}
    </div>

    {% if photos %}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
            {% for photo in photos %}
                <article class="relative group">
                    <img src="{{ photo.image.url }}" alt="{{ photo.title }}" class="w-full h-48 sm:h-56 md:h-64 object-cover rounded-sm" />
                    <div class="absolute top-2 right-2 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition">
                        <a href="{% url 'portfolio:edit_photo' photo.id %}?next={{ request.get_full_path }}" class="w-8 h-8 bg-black/70 text-white rounded-full flex items-center justify-center" aria-label="edit">
                            <svg viewBox="0 0 24 24" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 20h9" />
                                <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z" />
                            </svg>
                        </a>
                        <form method="post" action="{% url 'portfolio:delete_photo' photo.id %}" class="photo-delete-form">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                            <button type="submit" class="w-8 h-8 bg-black/70 text-white text-xs rounded-full">X</button>
                        </form>
                    </div>
                    <div class="mt-3">
                        <h3 class="text-sm font-medium">{{ photo.title }}</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            {% if photo.season %}{{ photo.season.name }}{% endif %}
                            {% if photo.zone %} · {{ photo.zone.name }}{% endif %}
                        </p>
                        <div class="flex flex-wrap gap-1 mt-2">
                            {% for tag in photo.tags.all %}
                                <span class="text-[10px] uppercase tracking-wider text-gray-400">#{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-sm text-gray-500">아직 업로드된 사진이 없습니다.</div>
    {% endif %}
</section>

{% if duplicate_names %}
    <div id="duplicate-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white max-w-md w-full p-6">
            <h3 class="text-lg font-medium mb-2">중복된 사진 {{ duplicate_names|length }}장</h3>
            <p class="text-xs text-gray-500 mb-4">중복되지 않은 파일만 업로드되었습니다.</p>
            <div class="max-h-40 overflow-y-auto text-xs text-gray-500 space-y-1 mb-4">
                {% for name in duplicate_names %}
                    <div>{{ name }}</div>
                {% endfor %}
            </div>
            <button id="duplicate-close" type="button" class="px-4 py-2 border text-xs">닫기</button>
        </div>
    </div>
{% endif %}

<script>
    const uploadToggle = document.getElementById('upload-toggle');
    const uploadForm = document.getElementById('upload-form');
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const fileCount = document.getElementById('file-count');
    const previewGrid = document.getElementById('preview-grid');
    const dropzoneEmpty = document.getElementById('dropzone-empty');

    const updateCount = (files) => {
        if (!files || files.length === 0) {
            fileCount.textContent = '선택된 파일 없음';
            return;
        }
        fileCount.textContent = `${files.length}장 선택됨`;
    };

    const renderPreviews = (files) => {
        if (!previewGrid || !dropzoneEmpty) {
            return;
        }
        previewGrid.innerHTML = '';
        if (!files || files.length === 0) {
            previewGrid.classList.add('hidden');
            dropzoneEmpty.classList.remove('hidden');
            return;
        }
        dropzoneEmpty.classList.add('hidden');
        previewGrid.classList.remove('hidden');
        Array.from(files).forEach((file) => {
            if (!file.type.startsWith('image/')) {
                return;
            }
            const url = URL.createObjectURL(file);
            const wrapper = document.createElement('div');
            wrapper.className = 'w-full aspect-[4/3] bg-white overflow-hidden rounded-sm';
            const img = document.createElement('img');
            img.src = url;
            img.alt = file.name;
            img.className = 'w-full h-full object-cover';
            img.onload = () => URL.revokeObjectURL(url);
            wrapper.appendChild(img);
            previewGrid.appendChild(wrapper);
        });
    };

    if (uploadToggle) {
        uploadToggle.addEventListener('click', () => {
            uploadForm.classList.toggle('hidden');
        });
    }

    if (dropzone && fileInput) {
        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropzone.classList.add('bg-white');
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('bg-white');
        });
        dropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropzone.classList.remove('bg-white');
            const files = Array.from(event.dataTransfer.files || []);
            if (files.length > 50) {
                fileCount.textContent = '50장 이하로 선택해주세요.';
                fileInput.value = '';
                return;
            }
            const dataTransfer = new DataTransfer();
            files.forEach((file) => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
            updateCount(fileInput.files);
            renderPreviews(fileInput.files);
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 50) {
                fileCount.textContent = '50장 이하로 선택해주세요.';
                fileInput.value = '';
                renderPreviews([]);
                return;
            }
            updateCount(fileInput.files);
            renderPreviews(fileInput.files);
        });
    }

    const duplicateModal = document.getElementById('duplicate-modal');
    const duplicateClose = document.getElementById('duplicate-close');
    if (duplicateModal && duplicateClose) {
        duplicateClose.addEventListener('click', () => {
            duplicateModal.classList.add('hidden');
        });
    }

    const deleteForms = document.querySelectorAll('.photo-delete-form');
    deleteForms.forEach((form) => {
        form.addEventListener('submit', (event) => {
            const ok = confirm('이 사진을 삭제하시겠습니까?');
            if (!ok) {
                event.preventDefault();
            }
        });
    });
</script>
{% endblock %}
