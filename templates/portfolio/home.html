{% extends 'base.html' %}

{% block title %}정원 | 순천만 국제정원{% endblock %}

{% block content %}
<section class="relative">
    <style>
        .season-bg {
            position: absolute;
            inset: 0;
            z-index: 0;
        }
        .season-bg.spring {
            background: linear-gradient(180deg, rgba(254, 242, 248, 0.95) 0%, rgba(255, 247, 237, 0.9) 100%);
        }
        .season-bg.summer {
            background: linear-gradient(180deg, rgba(239, 246, 255, 0.95) 0%, rgba(224, 242, 254, 0.9) 100%);
        }
        .season-bg.autumn {
            background: linear-gradient(180deg, rgba(255, 247, 237, 0.95) 0%, rgba(254, 243, 199, 0.9) 100%);
        }
        .season-bg.winter {
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.95) 100%);
        }
        .triple-carousel {
            height: 68vh;
        }
        .carousel-item {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 68%;
            max-width: 960px;
            transform: translate(-50%, -50%) scale(0.7);
            opacity: 0;
            transition: transform 700ms ease, opacity 700ms ease;
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            max-height: 60vh;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }
        .carousel-item.is-center {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            z-index: 3;
        }
        .carousel-item.is-left {
            opacity: 0.55;
            transform: translate(-120%, -50%) scale(0.75);
            z-index: 2;
        }
        .carousel-item.is-right {
            opacity: 0.55;
            transform: translate(20%, -50%) scale(0.75);
            z-index: 2;
        }
        .carousel-item.is-hidden {
            opacity: 0;
            pointer-events: none;
        }
        @media (max-width: 768px) {
            .triple-carousel { height: 56vh; }
            .carousel-item { width: 88%; }
            .carousel-item.is-left { transform: translate(-140%, -50%) scale(0.7); }
            .carousel-item.is-right { transform: translate(40%, -50%) scale(0.7); }
        }
        .season-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 5;
        }
        .season-particle {
            position: absolute;
            top: -10%;
            border-radius: 9999px;
            opacity: 0.7;
            animation: seasonal-fall linear infinite;
        }
        .season-particle.spring-petal {
            border-radius: 70% 30% 65% 35%;
            background: linear-gradient(145deg, rgba(251, 207, 232, 0.95), rgba(244, 114, 182, 0.6));
            box-shadow: inset -1px -1px 0 rgba(255, 255, 255, 0.55);
        }
        .season-particle.autumn-leaf {
            border-radius: 10% 80% 10% 80%;
            background: linear-gradient(155deg, rgba(253, 186, 116, 0.95), rgba(234, 88, 12, 0.72));
            transform-origin: 50% 70%;
        }
        .season-particle.autumn-leaf::after {
            content: '';
            position: absolute;
            left: 48%;
            top: 82%;
            width: 2px;
            height: 8px;
            background: rgba(120, 53, 15, 0.65);
            border-radius: 9999px;
        }
        .season-particle.winter-snow {
            border-radius: 0;
            background: transparent;
            box-shadow: none;
        }
        .season-particle.winter-snow::before {
            content: '❄';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(148, 163, 184, 0.95);
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8), 0 0 6px rgba(148, 163, 184, 0.35);
            font-size: 1em;
            line-height: 1;
        }
        .season-overlay.summer .season-particle {
            display: none;
        }
        .season-wave {
            position: absolute;
            left: -10%;
            bottom: 0;
            width: 120%;
            border-radius: 50% 50% 0 0;
            opacity: 0.45;
            animation: wave-drift 9s ease-in-out infinite;
            display: none;
        }
        .season-overlay.summer .season-wave {
            display: block;
        }
        .season-wave.wave-1 { height: 17%; background: rgba(191, 219, 254, 0.45); }
        .season-wave.wave-2 { height: 12%; background: rgba(147, 197, 253, 0.4); animation-delay: -2.4s; }
        .season-wave.wave-3 { height: 8%; background: rgba(96, 165, 250, 0.35); animation-delay: -4.8s; }
        @keyframes seasonal-fall {
            0% { transform: translate3d(0, -5vh, 0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.85; }
            100% { transform: translate3d(40px, 78vh, 0) rotate(300deg); opacity: 0; }
        }
        @keyframes wave-drift {
            0%, 100% { transform: translateX(0) translateY(0); }
            50% { transform: translateX(-4%) translateY(8px); }
        }
    </style>
    <div id="season-bg" class="season-bg" aria-hidden="true"></div>
    <div class="triple-carousel overflow-hidden bg-transparent relative z-10">
        <div id="season-overlay" class="season-overlay" aria-hidden="true">
            <div class="season-wave wave-1"></div>
            <div class="season-wave wave-2"></div>
            <div class="season-wave wave-3"></div>
        </div>
        <div class="h-full w-full relative">
            {% if recent_photos %}
                {% for photo in recent_photos %}
                    <div class="carousel-item" data-filename="{{ photo.original_filename|default:photo.image.name }}">
                        <img src="{{ photo.image.url }}" alt="{{ photo.title }}" />
                    </div>
                {% endfor %}
            {% else %}
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="text-gray-400">사진을 업로드해주세요.</div>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="max-w-4xl mx-auto px-6 mt-4 text-center text-xs text-gray-500" id="carousel-caption"></div>
</section>

<section class="max-w-6xl mx-auto px-6 -mt-12 md:-mt-16 relative z-10">
    <div class="bg-white shadow-sm border border-gray-100 px-5 py-4 flex flex-wrap gap-4 text-xs text-gray-600">
        <span>최근 업로드한 50장의 사진을 슬라이드로 감상하세요.</span>
        <span>중앙의 큰 사진이 현재 선택된 컷입니다.</span>
    </div>
</section>

<section class="max-w-6xl mx-auto px-6 mt-16">
    <div class="flex items-end justify-between mb-8">
        <h2 class="text-2xl font-light">최근 기록</h2>
        <a href="{% url 'portfolio:archive' %}" class="text-xs text-gray-500 hover:text-gray-900">전체 보기</a>
    </div>

    {% if latest_photos %}
        <div class="masonry">
            {% for photo in latest_photos %}
                <article class="masonry-item">
                    <img src="{{ photo.image.url }}" alt="{{ photo.title }}" class="w-full h-auto rounded-sm" />
                    <div class="mt-3">
                        <h3 class="text-sm font-medium">{{ photo.title }}</h3>
                        <p class="text-xs text-gray-500 mt-1">
                            {% if photo.season %}{{ photo.season.name }}{% endif %}
                            {% if photo.zone %} · {{ photo.zone.name }}{% endif %}
                        </p>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-sm text-gray-500">아직 업로드된 사진이 없습니다.</div>
    {% endif %}
</section>

<script>
    const carouselItems = Array.from(document.querySelectorAll('.carousel-item'));
    const caption = document.getElementById('carousel-caption');
    const seasonOverlay = document.getElementById('season-overlay');
    const seasonBg = document.getElementById('season-bg');
    let currentIndex = 0;

    const getCurrentSeason = () => {
        const month = new Date().getMonth() + 1;
        if ([3, 4, 5].includes(month)) return 'spring';
        if ([6, 7, 8].includes(month)) return 'summer';
        if ([9, 10, 11].includes(month)) return 'autumn';
        return 'winter';
    };

    const createParticles = (season) => {
        if (!seasonOverlay) {
            return;
        }
        seasonOverlay.classList.remove('spring', 'summer', 'autumn', 'winter');
        seasonOverlay.classList.add(season);

        seasonOverlay.querySelectorAll('.season-particle').forEach((node) => node.remove());
        if (season === 'summer') {
            return;
        }

        const config = {
            spring: { min: 8, max: 14, count: 16, shapeClass: 'spring-petal' },
            autumn: { min: 9, max: 15, count: 15, shapeClass: 'autumn-leaf' },
            winter: { min: 4, max: 9, count: 20, shapeClass: 'winter-snow' },
        }[season];

        for (let index = 0; index < config.count; index += 1) {
            const particle = document.createElement('span');
            particle.className = `season-particle ${config.shapeClass}`;
            const size = config.min + Math.random() * (config.max - config.min);
            const duration = 7 + Math.random() * 8;
            const delay = -Math.random() * duration;

            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            if (season === 'winter') {
                particle.style.fontSize = `${(size + 6) * 2}px`;
            }
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDuration = `${duration}s`;
            particle.style.animationDelay = `${delay}s`;
            seasonOverlay.appendChild(particle);
        }
    };

    const applySeasonBackground = (season) => {
        if (!seasonBg) {
            return;
        }
        seasonBg.classList.remove('spring', 'summer', 'autumn', 'winter');
        seasonBg.classList.add(season);
    };

    const applyClasses = () => {
        const total = carouselItems.length;
        if (!total) {
            return;
        }
        carouselItems.forEach((item) => {
            item.classList.remove('is-center', 'is-left', 'is-right', 'is-hidden');
            item.classList.add('is-hidden');
            item.setAttribute('aria-hidden', 'true');
        });
        const leftIndex = (currentIndex - 1 + total) % total;
        const rightIndex = (currentIndex + 1) % total;

        carouselItems[currentIndex].classList.remove('is-hidden');
        carouselItems[currentIndex].classList.add('is-center');
        carouselItems[currentIndex].setAttribute('aria-hidden', 'false');

        if (total > 1) {
            carouselItems[leftIndex].classList.remove('is-hidden');
            carouselItems[leftIndex].classList.add('is-left');
            carouselItems[rightIndex].classList.remove('is-hidden');
            carouselItems[rightIndex].classList.add('is-right');
        }

        if (caption) {
            caption.textContent = carouselItems[currentIndex].dataset.filename || '';
        }
    };

    if (carouselItems.length) {
        applyClasses();
        setInterval(() => {
            currentIndex = (currentIndex + 1) % carouselItems.length;
            applyClasses();
        }, 4500);
    }

    const activeSeason = getCurrentSeason();
    applySeasonBackground(activeSeason);
    createParticles(activeSeason);
</script>
{% endblock %}
